<!doctype html>
<html class="no-js">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="genindex.html" /><link rel="search" title="Search" href="search.html" /><link rel="next" title="Extending Inference with User defined type" href="extending_user_type.html" /><link rel="prev" title="Inference" href="inference.html" />

    <meta name="generator" content="sphinx-4.1.2, furo 2021.09.08"/>
        <title>Extending Klara - klara 0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo.css?digest=c7c65a82b42f6b978e58466c1e9ef2509836d916" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo-extensions.css?digest=16fb25fabf47304eee183a5e9af80b1ba98259b1" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  body[data-theme="dark"] {
    --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
  }
  @media (prefers-color-scheme: dark) {
    body:not([data-theme="light"]) {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
  }
</style></head>
  <body>
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" />
      <line x1="4" y1="6" x2="20" y2="6" />
      <line x1="10" y1="12" x2="20" y2="12" />
      <line x1="6" y1="18" x2="20" y2="18" />
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="index.html"><div class="brand">klara 0.1 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="index.html">
  
  
  <span class="sidebar-brand-text">klara 0.1 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="search.html" role="search">
  <input class="sidebar-search" placeholder=Search name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="quick_start.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="inference.html">Inference</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">Extending Klara</a></li>
<li class="toctree-l1"><a class="reference internal" href="extending_user_type.html">Extending Inference with User defined type</a></li>
<li class="toctree-l1"><a class="reference internal" href="customize_coverage_strategy.html">Customize Coverage Strategy</a></li>
<li class="toctree-l1"><a class="reference internal" href="plugins.html">Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="limitation.html">Limitation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="how_does_it_works.html">How Does It Work?</a></li>
<li class="toctree-l1"><a class="reference internal" href="cfg_ssa.html">Python ast transformation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="api.html">API</a></li>
</ul>

</div>
</div>
      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <div class="section" id="extending-klara">
<h1>Extending Klara<a class="headerlink" href="#extending-klara" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The interface is shamelessly stolen from the <a class="reference external" href="https://github.com/PyCQA/astroid">Astroid</a> project</p>
</div>
<p>Klara might not covered all features that you need, or there are custom behaviour interaction with
user defined type that you wish can be included in inference system. This is where Klara’s plugin interface
came into picture.</p>
<div class="section" id="node-transformation">
<h2>Node transformation<a class="headerlink" href="#node-transformation" title="Permalink to this headline">¶</a></h2>
<p>Before we introduce inference extension, we’ll need to introduce node transformation. Node transformation
allows Klara to transform a node during ast parsing.</p>
<p>The transform function need to be registered with the manager, i.e. <cite>klara.MANAGER</cite>. You’ll need:
1. The type of the node
2. The transform function that return a new node
3. A predicate function that receives node as argument and return a boolean to specify if transform should be happening.</p>
<p>Let’s assume that we’ll want to transform all <code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">//</span> <span class="pre">b</span></code> operation to a function call <code class="docutils literal notranslate"><span class="pre">floor(a,</span> <span class="pre">b)</span></code>.</p>
<p>We’ll write the following function that will return a new <cite>Call</cite> node from a <cite>BinOp</cite> argument. We’ll need to construct
a new node <code class="docutils literal notranslate"><span class="pre">klara.Call</span></code>. The node is similar to python’s ast, and you can refer to <a class="reference external" href="https://greentreesnakes.readthedocs.io/en/latest/nodes.html">python nodes documentation</a>
for more information. In Klara, we also maintain parent/child attribute between nodes, so you’ll need to
specify parent at the constructor, and specify node’s other attribute in <code class="docutils literal notranslate"><span class="pre">postinit()</span></code>.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">klara</span>

<span class="k">def</span> <span class="nf">transform_floor_call</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">klara</span><span class="o">.</span><span class="n">BinOp</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">klara</span><span class="o">.</span><span class="n">Call</span><span class="p">:</span>
    <span class="n">call_node</span> <span class="o">=</span> <span class="n">klara</span><span class="o">.</span><span class="n">Call</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">klara</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="n">call_node</span><span class="p">)</span>
    <span class="n">name</span><span class="o">.</span><span class="n">postinit</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">"floor"</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">right</span><span class="p">]</span>
    <span class="n">call_node</span><span class="o">.</span><span class="n">postinit</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="p">[])</span>
    <span class="k">return</span> <span class="n">call_node</span>
</pre></div>
</div>
<p>Then, we’ll create a predicate function that only target “//” operaton:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">is_floor_op</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">klara</span><span class="o">.</span><span class="n">BinOp</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">node</span><span class="o">.</span><span class="n">op</span> <span class="o">==</span> <span class="s2">"//"</span>
</pre></div>
</div>
<p>Finally, we’ll register the transform via <cite>MANAGER</cite>.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">klara</span><span class="o">.</span><span class="n">MANAGER</span><span class="o">.</span><span class="n">register_transform</span><span class="p">(</span><span class="n">klara</span><span class="o">.</span><span class="n">BinOp</span><span class="p">,</span> <span class="n">transform_floor_call</span><span class="p">,</span> <span class="n">is_floor_op</span><span class="p">)</span>
</pre></div>
</div>
<p>We can verify the transformation by parsing a source:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">source</span> <span class="o">=</span> <span class="s2">"""</span>
<span class="s2">    z = a // b</span>
<span class="s2">"""</span>
<span class="n">tree</span> <span class="o">=</span> <span class="n">klara</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</pre></div>
</div>
<p>This will print a function call <cite>floor((a, b))</cite>.</p>
<p>Putting all together:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">klara</span>

<span class="k">def</span> <span class="nf">transform_floor_call</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">klara</span><span class="o">.</span><span class="n">BinOp</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">klara</span><span class="o">.</span><span class="n">Call</span><span class="p">:</span>
    <span class="n">call_node</span> <span class="o">=</span> <span class="n">klara</span><span class="o">.</span><span class="n">Call</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">klara</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="n">call_node</span><span class="p">)</span>
    <span class="n">name</span><span class="o">.</span><span class="n">postinit</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">"floor"</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">left</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">right</span><span class="p">]</span>
    <span class="n">call_node</span><span class="o">.</span><span class="n">postinit</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="p">[])</span>
    <span class="k">return</span> <span class="n">call_node</span>


<span class="k">def</span> <span class="nf">is_floor_op</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">klara</span><span class="o">.</span><span class="n">BinOp</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">node</span><span class="o">.</span><span class="n">op</span> <span class="o">==</span> <span class="s2">"//"</span>


<span class="n">klara</span><span class="o">.</span><span class="n">MANAGER</span><span class="o">.</span><span class="n">register_transform</span><span class="p">(</span><span class="n">klara</span><span class="o">.</span><span class="n">BinOp</span><span class="p">,</span> <span class="n">transform_floor_call</span><span class="p">,</span> <span class="n">is_floor_op</span><span class="p">)</span>

<span class="n">source</span> <span class="o">=</span> <span class="s2">"""</span>
<span class="s2">    z = a // b</span>
<span class="s2">"""</span>
<span class="n">tree</span> <span class="o">=</span> <span class="n">klara</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="extending-inference">
<h2>Extending Inference<a class="headerlink" href="#extending-inference" title="Permalink to this headline">¶</a></h2>
<p>Extending node inference is similar to extending a node. Say we’ll want to implement <cite>abs()</cite> builtin function.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>some of the builtin functions (abs, int, float, str, len, round) has been implemented in
<cite>klara/plugins/builtin_inference.py</cite> file.</p>
</div>
<p>we’ll first start with the infer function for the <cite>abs()</cite> call:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@klara</span><span class="o">.</span><span class="n">inference</span><span class="o">.</span><span class="n">inference_transform_wrapper</span>
<span class="k">def</span> <span class="nf">infer_abs</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">klara</span><span class="o">.</span><span class="n">Call</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">arg</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">arg</span><span class="o">.</span><span class="n">infer</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">status</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">result</span><span class="p">,</span> <span class="n">klara</span><span class="o">.</span><span class="n">Const</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">klara</span><span class="o">.</span><span class="n">inference</span><span class="o">.</span><span class="n">InferenceResult</span><span class="o">.</span><span class="n">load_result</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">klara</span><span class="o">.</span><span class="n">inference</span><span class="o">.</span><span class="n">UseInferenceDefault</span><span class="p">()</span>
</pre></div>
</div>
<p>First, it will <cite>infer()</cite> the value of the first argument, and only apply <cite>abs()</cite> to a constant. We’ll
also need to return an InferenceResult type. Finally, we’ll raise <cite>klara.inference.UseInferenceDefault()</cite>
to use the default inference.</p>
<p>Next, we’ll write the predicate, which is just checking the function name as “abs”.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">is_abs_call</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">klara</span><span class="o">.</span><span class="n">Call</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">func</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"abs"</span>
</pre></div>
</div>
<p>Finally, we’ll register everything together.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">klara</span><span class="o">.</span><span class="n">MANAGER</span><span class="o">.</span><span class="n">register_transform</span><span class="p">(</span><span class="n">klara</span><span class="o">.</span><span class="n">Call</span><span class="p">,</span> <span class="n">infer_abs</span><span class="p">,</span> <span class="n">is_abs_call</span><span class="p">)</span>
</pre></div>
</div>
<p>We can test it out by parsing a source, and infer the corresponding node.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">source</span> <span class="o">=</span> <span class="s2">"""</span>
<span class="s2">s = 1 - 3</span>
<span class="s2">s *= 3</span>
<span class="s2">z = abs(s)</span>
<span class="s2">"""</span>
<span class="n">tree</span> <span class="o">=</span> <span class="n">klara</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">infer</span><span class="p">()))</span>
</pre></div>
</div>
<p>Which will print out <cite>[6]</cite></p>
<p>Putting everything together:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">klara</span>

<span class="nd">@klara</span><span class="o">.</span><span class="n">inference</span><span class="o">.</span><span class="n">inference_transform_wrapper</span>
<span class="k">def</span> <span class="nf">infer_abs</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">klara</span><span class="o">.</span><span class="n">Call</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">arg</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">arg</span><span class="o">.</span><span class="n">infer</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">status</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">result</span><span class="p">,</span> <span class="n">klara</span><span class="o">.</span><span class="n">Const</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">klara</span><span class="o">.</span><span class="n">inference</span><span class="o">.</span><span class="n">InferenceResult</span><span class="o">.</span><span class="n">load_result</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">klara</span><span class="o">.</span><span class="n">inference</span><span class="o">.</span><span class="n">UseInferenceDefault</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">is_abs_call</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">klara</span><span class="o">.</span><span class="n">Call</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">func</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"abs"</span>

<span class="n">klara</span><span class="o">.</span><span class="n">MANAGER</span><span class="o">.</span><span class="n">register_transform</span><span class="p">(</span><span class="n">klara</span><span class="o">.</span><span class="n">Call</span><span class="p">,</span> <span class="n">infer_abs</span><span class="p">,</span> <span class="n">is_abs_call</span><span class="p">)</span>

<span class="n">source</span> <span class="o">=</span> <span class="s2">"""</span>
<span class="s2">s = 1 - 3</span>
<span class="s2">s *= 3</span>
<span class="s2">z = abs(s)</span>
<span class="s2">"""</span>
<span class="n">tree</span> <span class="o">=</span> <span class="n">klara</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">infer</span><span class="p">()))</span>
<span class="c1"># [3]</span>
</pre></div>
</div>
</div>
<div class="section" id="inserting-as-a-plugin">
<h2>Inserting as a plugin<a class="headerlink" href="#inserting-as-a-plugin" title="Permalink to this headline">¶</a></h2>
<p>We can also put the transform in a file, and load it as a plugin via <code class="docutils literal notranslate"><span class="pre">--infer-extension</span></code> flag to <cite>klara</cite> command.
We can then place the code above in a file, and additionally create a function called <cite>register()</cite> and
<cite>unregister()</cite> that contain code to register/unregister inference transform:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">klara</span>


<span class="nd">@klara</span><span class="o">.</span><span class="n">inference</span><span class="o">.</span><span class="n">inference_transform_wrapper</span>
<span class="k">def</span> <span class="nf">infer_abs</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">klara</span><span class="o">.</span><span class="n">Call</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">arg</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">arg</span><span class="o">.</span><span class="n">infer</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">status</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">result</span><span class="p">,</span> <span class="n">klara</span><span class="o">.</span><span class="n">Const</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">klara</span><span class="o">.</span><span class="n">inference</span><span class="o">.</span><span class="n">InferenceResult</span><span class="o">.</span><span class="n">load_result</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">klara</span><span class="o">.</span><span class="n">inference</span><span class="o">.</span><span class="n">UseInferenceDefault</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">is_abs_call</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">klara</span><span class="o">.</span><span class="n">Call</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">func</span><span class="p">)</span> <span class="o">==</span> <span class="s2">"abs"</span>


<span class="k">def</span> <span class="nf">register</span><span class="p">():</span>
    <span class="n">klara</span><span class="o">.</span><span class="n">MANAGER</span><span class="o">.</span><span class="n">register_transform</span><span class="p">(</span><span class="n">klara</span><span class="o">.</span><span class="n">Call</span><span class="p">,</span> <span class="n">infer_abs</span><span class="p">,</span> <span class="n">is_abs_call</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">unregister</span><span class="p">():</span>
    <span class="n">klara</span><span class="o">.</span><span class="n">MANAGER</span><span class="o">.</span><span class="n">unregister_transform</span><span class="p">(</span><span class="n">klara</span><span class="o">.</span><span class="n">Call</span><span class="p">,</span> <span class="n">infer_abs</span><span class="p">,</span> <span class="n">is_abs_call</span><span class="p">)</span>
</pre></div>
</div>
<p>We can then run with klara, with following python file <code class="docutils literal notranslate"><span class="pre">source.py</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">v1</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">v2</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">v1</span> <span class="o">&gt;</span> <span class="n">v2</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">v1</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="o">-</span><span class="mi">999</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">v2</span>
</pre></div>
</div>
<p>And assuming that the inference transform file is called <code class="docutils literal notranslate"><span class="pre">inference_extension.py</span></code>, we can then invoke klara by:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">klara</span> <span class="n">source</span><span class="o">.</span><span class="n">py</span> <span class="o">--</span><span class="n">infer</span><span class="o">-</span><span class="n">extension</span> <span class="n">inference_extension</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>which will generate <cite>test_source.py</cite>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">source</span>


<span class="k">def</span> <span class="nf">test_foo_0</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">source</span><span class="o">.</span><span class="n">foo</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">999</span>
    <span class="k">assert</span> <span class="n">source</span><span class="o">.</span><span class="n">foo</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
</pre></div>
</div>
<p>Klara contain some plugins for python’s built in function, typeshed etc… that can be found in <cite>klara/plugins/</cite> and
<cite>klara/klara_z3/plugins</cite> directory.</p>
</div>
</div>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="extending_user_type.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Extending Inference with User defined type</div>
              </div>
              <svg><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="inference.html">
              <svg><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Inference</div>
                
              </div>
            </a>
        </div>

        <div class="related-information">
              Copyright &#169; 2021, usagitoneko97 |
            Built with <a href="https://www.sphinx-doc.org/">Sphinx</a>
              and
              <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
              <a href="https://github.com/pradyunsg/furo">Furo theme</a>. |
            <a class="muted-link" href="_sources/extending.rst.txt"
               rel="nofollow">
              Show Source
            </a>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            Contents
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Extending Klara</a><ul>
<li><a class="reference internal" href="#node-transformation">Node transformation</a></li>
<li><a class="reference internal" href="#extending-inference">Extending Inference</a></li>
<li><a class="reference internal" href="#inserting-as-a-plugin">Inserting as a plugin</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/scripts/main.js"></script>
    </body>
</html>